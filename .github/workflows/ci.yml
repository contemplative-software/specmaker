name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  ci:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Format
        run: cd specmaker-core && uvx ruff format . --check --diff

      - name: Lint
        run: cd specmaker-core && uvx ruff check --output-format=github .

      - name: Type Check
        run: cd specmaker-core && uv run --frozen pyright

      - name: Run Tests with Coverage
        run: cd specmaker-core && uv run --frozen pytest --cov=src/specmaker_core --cov-report=xml --cov-report=term-missing --junitxml=pytest.xml --cov-fail-under=0

      - name: Fetch base branch for diff coverage
        run: git fetch origin main

      - name: Diff coverage (changed files only, fail <90%)
        run: |
          cd specmaker-core
          uv run --frozen diff-cover coverage.xml --compare-branch=origin/main --fail-under=90

      - name: Coverage comment (changed files only)
        if: ${{ always() && github.event_name == 'pull_request' }}
        uses: MishaKav/pytest-coverage-comment@main
        with:
          github-token: ${{ github.token }}
          pytest-coverage-path: specmaker-core/coverage.xml
          junitxml-path: specmaker-core/pytest.xml
          report-only-changed-files: true
